<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Valonia · Bag Wizard</title>

<!-- Favicon & PWA -->
<link rel="icon" type="image/png" href="assets/img/logo-valonia_icons.png">
<link rel="apple-touch-icon" href="assets/img/logo-valonia_icons.png">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#c59a8b">

<!-- Estilos: limpio, fino, terracota y pastel -->
<style>
  :root{
    --bg:#f7f6f4;
    --ink:#6e4a3b;           /* terracota tipografía */
    --line:#e7e1dc;
    --pill:#efc7c3;          /* rosa pastel botones */
    --pillH:#e8b7b1;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);
    color:var(--ink);
    font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .wrap{max-width:1200px;margin:24px auto 64px;padding:0 18px}
  .grid{
    display:grid; gap:24px;
    grid-template-columns: minmax(520px, 1fr) 430px;   /* bolso izq / panel dcha */
    align-items:start;
  }

  /* Lado izquierdo (escena) */
  .stage{display:flex; align-items:flex-start; justify-content:flex-start}
  /* Canvas: SIN borde blanco, proporción 600x800 visible, limpio */
  #cv{display:block; width:600px; height:800px; border:0; border-radius:0; background:#fff0}

  /* Lado derecho (panel) */
  .panel{display:flex; flex-direction:column; gap:16px}
  .logo{display:block; width:120px; margin:6px auto 6px auto}
  h1{
    margin:0 0 6px 0; text-align:center;
    font-family: Didot, "Bodoni Moda", "Times New Roman", serif;
    font-weight:400; letter-spacing:.2px; font-size:28px;
  }

  .card{
    background:transparent; border:0; border-radius:14px; padding:0;
  }
  .row{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:12px; margin:8px 0}
  .label{font-size:13px; letter-spacing:.3px}
  select{
    appearance:none; border:1px solid var(--line); background:#fff; color:var(--ink);
    padding:8px 10px; border-radius:12px; min-width:120px;
    box-shadow:0 0 0 0 rgba(0,0,0,0);
  }
  /* circulitos color más pequeños, redondos */
  input[type="color"]{
    -webkit-appearance:none; appearance:none; border:none; width:36px; height:36px;
    border-radius:50%; padding:0; background:transparent; box-shadow:0 0 0 2px #fff, 0 0 0 1px var(--line);
    cursor:pointer;
  }

  .actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:6px}
  .btn{
    cursor:pointer; border:none; border-radius:14px; padding:10px 14px;
    background:var(--pill); color:#5a3b2f; font-weight:600;
    box-shadow:0 1px 0 rgba(0,0,0,.05);
  }
  .btn:hover{background:var(--pillH)}

  /* Formulario más limpio y con aire */
  .form{
    margin-top:8px; padding-top:8px; border-top:1px dashed var(--line);
    display:grid; gap:10px;
  }
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .input, .textarea{
    width:100%; border:1px solid var(--line); border-radius:12px;
    padding:10px 12px; background:#fff; color:var(--ink);
  }
  .textarea{min-height:88px; resize:vertical}
  .consent{display:flex; align-items:center; gap:8px; font-size:13px; color:#7a5b4f}
  .small{font-size:12px; opacity:.8}

  /* Ajustes responsivos: en móvil todo centrado y apilado */
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr; gap:22px}
    .stage{justify-content:center}
    #cv{width:min(86vw, 520px); height:auto;}
    .panel{max-width:520px; margin:0 auto}
    .logo{margin-top:0}
    h1{font-size:26px}
    .grid2{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="grid">

      <!-- IZQUIERDA: bolso -->
      <div class="stage">
        <!-- canvas de 600x800 como requiere customizer.js -->
        <canvas id="cv" width="600" height="800"></canvas>
      </div>

      <!-- DERECHA: logo + título + controles + formulario -->
      <div class="panel">
        <img class="logo" src="assets/img/logo-valonia.png" alt="Valonia">

        <h1>Diseña tu Tambour</h1>

        <div class="card">
          <div class="row">
            <div class="label">1º CUERO · TEXTURA</div>
            <div></div>
          </div>
          <div class="row">
            <select id="texA">
              <option value="smooth">Lisa</option>
              <option value="suede">Ante</option>
            </select>
            <input id="colA" type="color" value="#e6c0c3" aria-label="Color cuero 1">
          </div>

          <div class="row" style="margin-top:6px">
            <div class="label">2º CUERO · TEXTURA</div>
            <div></div>
          </div>
          <div class="row">
            <select id="texB">
              <option value="smooth">Lisa</option>
              <option value="suede">Ante</option>
            </select>
            <input id="colB" type="color" value="#7a4c3b" aria-label="Color cuero 2">
          </div>

          <!-- Costura (C) – no mostramos etiqueta grande, solo selector (negro por defecto) -->
          <div class="row" style="margin-top:8px">
            <div class="label">Costura (C)</div>
            <input id="stitchColor" type="color" value="#111111" aria-label="Color costura">
          </div>

          <div class="actions">
            <button id="dl" class="btn">Descargar preview</button>
            <button id="makePdf" class="btn" type="button">Generar PDF del pedido</button>
            <input type="hidden" id="spbc_config_json">
          </div>
        </div>

        <!-- Formulario de pedido -->
        <form id="orderForm" class="form" onsubmit="return false">
          <div class="grid2">
            <input class="input" name="nombre" placeholder="Nombre y apellidos" required>
            <input class="input" name="email" type="email" placeholder="Email" required>
          </div>
          <div class="grid2">
            <input class="input" name="telefono" type="tel" placeholder="Teléfono" required>
            <!-- Referencia de pedido eliminada como pediste -->
          </div>
          <textarea class="textarea" name="notas" placeholder="Color interior, largo de correas, observaciones…"></textarea>

          <label class="consent">
            <input type="checkbox" id="ok" required>
            <span>Acepto la política de privacidad y el tratamiento de datos para gestionar este pedido.</span>
          </label>
          <div class="small">El PDF incluirá la previsualización del bolso y la configuración elegida.</div>
        </form>
      </div>

    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
  <!-- jsPDF para el PDF del pedido -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Tu lógica: NO tocamos nada; solo lo cargamos -->
  <script src="js/customizer.js"></script>

  <!-- Generar PDF sin romper tu flujo -->
  <script>
    const makePdfBtn = document.getElementById('makePdf');
    makePdfBtn.addEventListener('click', async () => {
      if(!document.getElementById('ok').checked){
        alert('Debes aceptar la política de privacidad para generar el PDF.');
        return;
      }

      const { jsPDF } = window.jspdf;
      const snap = (window.getWizardSnapshot && window.getWizardSnapshot()) || null;

      // Datos del formulario
      const fd = new FormData(document.getElementById('orderForm'));
      const data = Object.fromEntries(fd.entries());

      const doc = new jsPDF({ unit:'mm', format:'a4' });

      // Encabezado con logo
      const logo = new Image();
      logo.src = 'assets/img/logo-valonia.png';
      await new Promise(res => { logo.onload = res; logo.onerror = res; });
      try{ doc.addImage(logo, 'PNG', 15, 12, 28, 28); }catch(e){ /* si falla, seguimos */ }

      doc.setTextColor(60,45,38);
      doc.setFont('Times', 'normal');
      doc.setFontSize(16);
      doc.text('Pedido personalizado — Tambour', 50, 20);

      let y = 30;

      // Imagen preview (tu canvas es 600x800)
      if(snap && snap.png){
        const w = 80, h = w * (800/600);         // mantiene proporción
        doc.addImage(snap.png, 'PNG', 15, y, w, h);
      }

      // Bloque de datos y configuración
      y += 4;
      doc.setFontSize(12);
      const xInfo = 110;
      doc.text('Datos del cliente', xInfo, y); y += 6;
      doc.setFontSize(11);
      doc.text(`Nombre: ${data.nombre || ''}`, xInfo, y); y += 5;
      doc.text(`Email: ${data.email || ''}`, xInfo, y); y += 5;
      doc.text(`Teléfono: ${data.telefono || ''}`, xInfo, y); y += 8;

      doc.setFontSize(12);
      doc.text('Configuración elegida', xInfo, y); y += 6;
      doc.setFontSize(11);
      try{
        const cfg = snap ? snap.config : {};
        doc.text(`1º cuero — textura: ${cfg?.A?.texture || ''} · color: ${cfg?.A?.color || ''}`, xInfo, y); y += 5;
        doc.text(`2º cuero — textura: ${cfg?.B?.texture || ''} · color: ${cfg?.B?.color || ''}`, xInfo, y); y += 5;
        if(cfg?.C?.color){ doc.text(`Costura: ${cfg.C.color}`, xInfo, y); y += 5; }
      }catch(e){}

      y += 5;
      doc.setFontSize(12);
      doc.text('Notas', 15, y); y += 6;
      doc.setFontSize(11);
      doc.text((data.notas || ''), 15, y, { maxWidth: 180 });

      const stamp = new Date().toISOString().slice(0,10);
      doc.save(`valonia-pedido-${stamp}.pdf`);
    });

    /* PWA: registrar SW (silencioso) */
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=> {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>